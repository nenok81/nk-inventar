<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0d6efd" />
  <title>NKk Inventar ‚Äì Lager</title>

  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />

  <style>
    :root{--bg:#ffffff;--card:#f8f9fc;--text:#0b1020;--muted:#667085;--primary:#0d6efd;--line:#e5e7ef;}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    header{display:flex;align-items:center;gap:10px;padding:8px 0}
    .logo{font-weight:800;color:var(--primary);letter-spacing:.5px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:6px;margin:8px 0}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;color:#111;cursor:pointer}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
    input,select,textarea,button{font-size:14px}
    input,select,textarea{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff;color:#111;min-width:0}
    textarea{min-height:70px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:#fff;color:#111;border:1px solid #cfd4ea}
    button.warn{background:#c0392b;border-color:#c0392b}
    .grid{display:grid;gap:8px}
    .grid-4{grid-template-columns:repeat(4,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    @media (max-width:720px){.grid-4,.grid-3,.grid-2{grid-template-columns:1fr}}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:middle}
    th{color:#475467;font-weight:600}
    .thumb{width:42px;height:42px;object-fit:cover;border-radius:8px;border:1px solid var(--line);background:#fff}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .right{margin-left:auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin:6px 0}
    .hide{display:none}
    .msg{font-size:13px;color:#667085;min-height:18px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row">
      <div class="logo">NK INVENTAR</div>
      <span class="pill">PWA aktiv</span>
      <div class="row right">
        <span id="who" class="pill"></span>
        <a class="tab" href="/index.html">Home</a>
      </div>
    </header>

    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="artikel">Artikel</button>
      <button class="tab" data-tab="lagerorte">Lagerorte</button>
      <button class="tab" data-tab="kunden">Kunden</button>
    </div>

    <!-- ARTIKEL -->
    <section id="artikel" class="card">
      <h3 style="margin:4px 0 10px">Artikel erfassen</h3>
      <form id="artikelForm" class="grid grid-4" autocomplete="off">
        <input id="aSku" placeholder="SKU *" required />
        <input id="aName" placeholder="Name *" required />
        <input id="aQty" type="number" placeholder="Menge *" value="0" min="0" required />
        <input id="aBild" type="file" accept="image/*" />
        <select id="aLager" required></select>
        <select id="aKunde"></select>
        <button type="submit">Speichern</button>
        <button type="button" id="aReset" class="ghost">Leeren</button>
        <input type="hidden" id="aId" />
      </form>
      <div class="msg" id="aMsg"></div>

      <div class="toolbar">
        <input id="aSearch" placeholder="Suche (SKU/Name)" style="flex:1" />
        <button id="aReload" class="ghost">Neu laden</button>
      </div>

      <table>
        <thead><tr><th>Bild</th><th>SKU</th><th>Name</th><th>Menge</th><th>Lagerort</th><th>Kunde</th><th>Aktion</th></tr></thead>
        <tbody id="aList"></tbody>
      </table>
    </section>

    <!-- LAGERORTE -->
    <section id="lagerorte" class="card hide">
      <h3 style="margin:4px 0 10px">Lagerort</h3>
      <form id="lagerForm" class="grid grid-3" autocomplete="off">
        <input id="lName" placeholder="Lagername *" required />
        <input id="lDesc" placeholder="Beschreibung" />
        <input id="lBild" type="file" accept="image/*" />
        <button type="submit">Speichern</button>
        <button type="button" id="lReset" class="ghost">Leeren</button>
        <input type="hidden" id="lId" />
      </form>
      <div class="msg" id="lMsg"></div>

      <div class="toolbar">
        <input id="lSearch" placeholder="Suche Lagerort" style="flex:1" />
        <button id="lReload" class="ghost">Neu laden</button>
      </div>

      <table>
        <thead><tr><th>Bild</th><th>Name</th><th>Beschreibung</th><th>Aktion</th></tr></thead>
        <tbody id="lList"></tbody>
      </table>
    </section>

    <!-- KUNDEN -->
    <section id="kunden" class="card hide">
      <h3 style="margin:4px 0 10px">Kunde</h3>
      <form id="kundeForm" class="grid grid-3" autocomplete="off">
        <input id="kName" placeholder="Name *" required />
        <input id="kAdresse" placeholder="Adresse" />
        <input id="kTelefon" placeholder="Telefon" />
        <input id="kEmail" type="email" placeholder="E-Mail" />
        <button type="submit">Speichern</button>
        <button type="button" id="kReset" class="ghost">Leeren</button>
        <input type="hidden" id="kId" />
      </form>
      <div class="msg" id="kMsg"></div>

      <div class="toolbar">
        <input id="kSearch" placeholder="Suche Kunde" style="flex:1" />
        <button id="kReload" class="ghost">Neu laden</button>
      </div>

      <table>
        <thead><tr><th>Name</th><th>Adresse</th><th>Telefon</th><th>E-Mail</th><th>Aktion</th></tr></thead>
        <tbody id="kList"></tbody>
      </table>
    </section>
  </div>

  <!-- Firebase compat SDKs (laufen stabil in Mobile/WebView) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-storage-compat.js"></script>

  <script>
    // üëâüëâüëâ HIER DEINE KONFIG AUS DER FIREBASE-KONSOLE EINF√úGEN
    const firebaseConfig = {
  apiKey: "AIzaSyD4oIfqmOOWSbUwD1cHn-fHv9qo5RSa47o",
  authDomain: "nk-inventar.firebaseapp.com",
  projectId: "nk-inventar",
  storageBucket: "nk-inventar.firebasestorage.app",
  messagingSenderId: "1007484310315",
  appId: "1:1007484310315:web:3069564137e9a728b1eb6e",
  measurementId: "G-PBSF173GG0"
};

    // Init
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    const provider = new firebase.auth.GoogleAuthProvider();

    // UI helpers
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const whoEl = $('#who');

    auth.onAuthStateChanged(u=>{
      whoEl.textContent = u ? (u.email || 'angemeldet') : 'Nicht angemeldet';
    });

    async function ensureLogin(){
      if (auth.currentUser) return auth.currentUser;
      try {
        const cred = await auth.signInWithPopup(provider);
        return cred.user;
      } catch {
        await auth.signInWithRedirect(provider);
        return new Promise(()=>{});
      }
    }

    // Tabs
    $$('#tabs .tab').forEach(b=>{
      b.onclick = ()=>{
        $$('#tabs .tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        ['artikel','lagerorte','kunden'].forEach(id=>{
          document.getElementById(id).classList.toggle('hide', id!==b.dataset.tab);
        });
      };
    });

    /* ---------- DROPDOWNS F√úR ARTIKEL ---------- */
    async function fillLagerDropdown(){
      const s = await db.collection('lagerorte').orderBy('name').get();
      const sel = $('#aLager'); sel.innerHTML = '<option value="">Lagerort w√§hlen *</option>';
      s.forEach(d=> sel.insertAdjacentHTML('beforeend', `<option value="${d.id}">${(d.data().name||'(ohne Name)')}</option>`));
    }
    async function fillKundenDropdown(){
      const s = await db.collection('kunden').orderBy('name').get();
      const sel = $('#aKunde'); sel.innerHTML = '<option value="">(optional) Kunde w√§hlen</option>';
      s.forEach(d=> sel.insertAdjacentHTML('beforeend', `<option value="${d.id}">${(d.data().name||'(ohne Name)')}</option>`));
    }
    fillLagerDropdown(); fillKundenDropdown();

    /* ---------- KUNDEN ---------- */
    const kForm = $('#kundeForm'), kMsg = $('#kMsg'), kList = $('#kList'), kId = $('#kId');
    const kName = $('#kName'), kAdresse = $('#kAdresse'), kTelefon = $('#kTelefon'), kEmail = $('#kEmail'), kSearch = $('#kSearch');

    function renderKunden(docs, filter=""){
      let html=""; docs.forEach(docSnap=>{
        const k = docSnap.data();
        const term = `${k.name||''} ${k.email||''} ${k.telefon||''}`.toLowerCase();
        if (filter && !term.includes(filter.toLowerCase())) return;
        html += `<tr>
          <td>${k.name||''}</td><td>${k.adresse||''}</td><td>${k.telefon||''}</td><td>${k.email||''}</td>
          <td>
            <button class="ghost kEdit" data-id="${docSnap.id}">‚úèÔ∏è</button>
            <button class="warn kDel" data-id="${docSnap.id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      });
      kList.innerHTML = html || '<tr><td colspan="5" class="muted">Keine Kunden</td></tr>';

      $$('.kEdit').forEach(b=> b.onclick = async ()=>{
        const s = await db.collection('kunden').doc(b.dataset.id).get();
        if (s.exists){
          const v = s.data();
          kId.value = s.id; kName.value = v.name||''; kAdresse.value = v.adresse||'';
          kTelefon.value = v.telefon||''; kEmail.value = v.email||'';
          kMsg.textContent = 'Bearbeiten ‚Äì √§ndere Felder und Speichere.';
        }
      });
      $$('.kDel').forEach(b=> b.onclick = async ()=>{
        await ensureLogin(); await db.collection('kunden').doc(b.dataset.id).delete();
      });
      fillKundenDropdown(); // damit Artikel-Form immer aktuelle Kunden hat
    }

    db.collection('kunden').orderBy('name').onSnapshot(s=>{
      const arr=[]; s.forEach(d=>arr.push(d)); renderKunden(arr, kSearch?.value?.trim()||"");
    });

    kForm?.addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        await ensureLogin();
        const data = {
          name:kName.value.trim(), adresse:kAdresse.value.trim(),
          telefon:kTelefon.value.trim(), email:kEmail.value.trim(), updatedAt: Date.now()
        };
        if (!data.name){ kMsg.textContent='Name fehlt'; return; }
        if (kId.value){ await db.collection('kunden').doc(kId.value).set(data,{merge:true}); kMsg.textContent='Kunde aktualisiert ‚úì'; }
        else { data.createdAt=Date.now(); await db.collection('kunden').add(data); kMsg.textContent='Kunde gespeichert ‚úì'; }
        kForm.reset(); kId.value="";
      }catch(err){ kMsg.textContent = 'Fehler: ' + (err.message||err); }
    });
    $('#kReset')?.addEventListener('click', ()=>{ kForm.reset(); kId.value=""; kMsg.textContent=""; });
    $('#kReload')?.addEventListener('click', ()=>location.reload());
    kSearch?.addEventListener('input', async ()=>{
      const s = await db.collection('kunden').orderBy('name').get();
      const arr=[]; s.forEach(d=>arr.push(d)); renderKunden(arr, kSearch.value.trim());
    });

    /* ---------- LAGERORTE ---------- */
    const lForm = $('#lagerForm'), lMsg = $('#lMsg'), lList = $('#lList'), lId = $('#lId');
    const lName = $('#lName'), lDesc = $('#lDesc'), lBild = $('#lBild'), lSearch = $('#lSearch');

    function renderLager(docs, filter=""){
      let html=""; docs.forEach(docSnap=>{
        const v = docSnap.data();
        if (filter && !(v.name||'').toLowerCase().includes(filter.toLowerCase())) return;
        html += `<tr>
          <td>${v.bildUrl ? `<img class="thumb" src="${v.bildUrl}" />` : ""}</td>
          <td>${v.name||""}</td>
          <td>${v.beschreibung||""}</td>
          <td>
            <button class="ghost lEdit" data-id="${docSnap.id}">‚úèÔ∏è</button>
            <button class="warn lDel" data-id="${docSnap.id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      });
      lList.innerHTML = html || '<tr><td colspan="4" class="muted">Keine Lagerorte</td></tr>';

      $$('.lEdit').forEach(b=> b.onclick = async ()=>{
        const s = await db.collection('lagerorte').doc(b.dataset.id).get();
        if (s.exists){
          const v = s.data();
          lId.value=s.id; lName.value=v.name||''; lDesc.value=v.beschreibung||'';
          lMsg.textContent='Bearbeiten ‚Äì anpassen und speichern.';
        }
      });
      $$('.lDel').forEach(b=> b.onclick = async ()=>{
        await ensureLogin(); await db.collection('lagerorte').doc(b.dataset.id).delete();
      });
      fillLagerDropdown(); // f√ºr Artikel-Form
    }

    db.collection('lagerorte').orderBy('name').onSnapshot(s=>{
      const arr=[]; s.forEach(d=>arr.push(d)); renderLager(arr, lSearch?.value?.trim()||"");
    });

    lForm?.addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        await ensureLogin();
        const name = lName.value.trim(); if (!name){ lMsg.textContent='Name fehlt'; return; }
        const beschreibung = lDesc.value.trim();
        let bildUrl = "";
        const file = lBild.files && lBild.files[0] ? lBild.files[0] : null;
        if (file){
          const ref = storage.ref().child(`lagerorte/${Date.now()}_${file.name}`);
          await ref.put(file); bildUrl = await ref.getDownloadURL();
        }
        const data = { name, beschreibung, updatedAt: Date.now() }; if (bildUrl) data.bildUrl = bildUrl;
        if (lId.value){ await db.collection('lagerorte').doc(lId.value).set(data,{merge:true}); lMsg.textContent='Lagerort aktualisiert ‚úì'; }
        else { data.createdAt=Date.now(); await db.collection('lagerorte').add(data); lMsg.textContent='Lagerort gespeichert ‚úì'; }
        lForm.reset(); lId.value="";
      }catch(err){ lMsg.textContent='Fehler: '+(err.message||err); }
    });
    $('#lReset')?.addEventListener('click', ()=>{ lForm.reset(); lId.value=""; lMsg.textContent=""; });
    $('#lReload')?.addEventListener('click', ()=>location.reload());
    lSearch?.addEventListener('input', async ()=>{
      const s = await db.collection('lagerorte').orderBy('name').get();
      const arr=[]; s.forEach(d=>arr.push(d)); renderLager(arr, lSearch.value.trim());
    });

    /* ---------- ARTIKEL ---------- */
    const aForm = $('#artikelForm'), aMsg = $('#aMsg'), aList = $('#aList'), aId = $('#aId');
    const aSku = $('#aSku'), aName = $('#aName'), aQty = $('#aQty'), aBild = $('#aBild');
    const aLager = $('#aLager'), aKunde = $('#aKunde'), aSearch = $('#aSearch');

    function renderArtikel(docs, lagerMap, kundenMap, filter=""){
      let html=""; docs.forEach(d=>{
        const a = d.data();
        const term = ((a.sku||"")+" "+(a.name||"")).toLowerCase();
        if (filter && !term.includes(filter.toLowerCase())) return;
        html += `<tr>
          <td>${a.bildUrl ? `<img class="thumb" src="${a.bildUrl}" />` : ""}</td>
          <td>${a.sku||""}</td><td>${a.name||""}</td>
          <td class="qty">${a.qty ?? 0}</td>
          <td>${lagerMap[a.lagerortId]||""}</td>
          <td>${kundenMap[a.kundeId]||""}</td>
          <td>
            <button class="ghost aEdit" data-id="${d.id}">‚úèÔ∏è</button>
            <button class="ghost aPlus" data-id="${d.id}">+1</button>
            <button class="ghost aMinus" data-id="${d.id}">‚àí1</button>
            <button class="warn aDel" data-id="${d.id}">üóëÔ∏è</button>
          </td>
        </tr>`;
      });
      aList.innerHTML = html || '<tr><td colspan="7" class="muted">Keine Artikel</td></tr>';

      $$('.aEdit').forEach(b=> b.onclick = async ()=>{
        const s = await db.collection('artikel').doc(b.dataset.id).get();
        if (s.exists){
          const v = s.data();
          aId.value = s.id; aSku.value=v.sku||''; aName.value=v.name||''; aQty.value=v.qty ?? 0;
          aLager.value = v.lagerortId || ""; aKunde.value = v.kundeId || "";
          aMsg.textContent='Bearbeiten ‚Äì anpassen und speichern.';
        }
      });
      $$('.aDel').forEach(b=> b.onclick = async ()=>{
        await ensureLogin(); await db.collection('artikel').doc(b.dataset.id).delete();
      });
      $$('.aPlus').forEach(b=> b.onclick = async ()=>{
        await ensureLogin();
        await db.collection('artikel').doc(b.dataset.id).update({ qty: firebase.firestore.FieldValue.increment(1) });
      });
      $$('.aMinus').forEach(b=> b.onclick = async ()=>{
        await ensureLogin();
        const ref = db.collection('artikel').doc(b.dataset.id);
        const snap = await ref.get(); const cur = snap.exists ? (snap.data().qty||0) : 0;
        await ref.update({ qty: Math.max(0, cur-1) });
      });
    }

    // Live-Artikel + Referenzen
    db.collection('artikel').orderBy('name').onSnapshot(async snap=>{
      const docs=[]; snap.forEach(d=>docs.push(d));
      const lagerMap={}, kundenMap={};
      const [ls, ks] = await Promise.all([ db.collection('lagerorte').get(), db.collection('kunden').get() ]);
      ls.forEach(d=>{ lagerMap[d.id] = (d.data().name||""); });
      ks.forEach(d=>{ kundenMap[d.id] = (d.data().name||""); });
      renderArtikel(docs, lagerMap, kundenMap, aSearch?.value?.trim()||"");
    });

    // Formular Artikel
    aForm?.addEventListener('submit', async e=>{
      e.preventDefault();
      try{
        await ensureLogin();
        const sku = aSku.value.trim(), name = aName.value.trim();
        const qty = parseInt(aQty.value||"0",10)||0;
        const lagerId = aLager.value || ""; const kundeId = aKunde.value || "";
        if (!sku || !name || !lagerId){ aMsg.textContent='SKU/Name/Lagerort erforderlich'; return; }
        let url="";
        const file = aBild.files && aBild.files[0] ? aBild.files[0] : null;
        if (file){
          const ref = storage.ref().child(`artikel/${Date.now()}_${file.name}`);
          await ref.put(file); url = await ref.getDownloadURL();
        }
        const data = { sku, name, qty, lagerortId: lagerId, kundeId, updatedAt: Date.now() };
        if (url) data.bildUrl = url;

        if (aId.value){ await db.collection('artikel').doc(aId.value).set(data,{merge:true}); aMsg.textContent='Artikel aktualisiert ‚úì'; }
        else { data.createdAt=Date.now(); await db.collection('artikel').add(data); aMsg.textContent='Artikel gespeichert ‚úì'; }
        aForm.reset(); aId.value="";
      }catch(err){ aMsg.textContent='Fehler: '+(err.message||err); }
    });

    // Suche/Reload/Reset
    $('#aReload')?.addEventListener('click', ()=>location.reload());
    $('#aReset') ?.addEventListener('click', ()=>{ aForm.reset(); aId.value=""; aMsg.textContent=""; });
    aSearch?.addEventListener('input', async ()=>{
      const docs=[]; const s = await db.collection('artikel').orderBy('name').get(); s.forEach(d=>docs.push(d));
      const lagerMap={}, kundenMap={};
      const [ls, ks] = await Promise.all([ db.collection('lagerorte').get(), db.collection('kunden').get() ]);
      ls.forEach(d=>{ lagerMap[d.id]=(d.data().name||""); }); ks.forEach(d=>{ kundenMap[d.id]=(d.data().name||""); });
      renderArtikel(docs, lagerMap, kundenMap, aSearch.value.trim());
    });

    // SW registrieren
    if ('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('/sw.js').catch(console.error)); }
  </script>
</body>
</html>